<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ­Ù„ÛŒÙ„ÛŒ Ø§Ø±Ø¬Ø§Ø¹ÛŒØ§Øª - Ù†ÙˆØ± ØªÙˆØ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
        }
        * { font-family: 'Vazir', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .nav-link { transition: all 0.3s ease; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.2); }
        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15); }
        .table-row-hover:hover { background: rgba(139, 92, 246, 0.1); }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #f59e0b; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
    <nav class="bg-purple-800 text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <i class="fas fa-chart-pie text-3xl ml-3"></i>
                    <span class="text-2xl font-bold">Ø³ÛŒØ³ØªÙ… ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ CRM</span>
                </div>
                <div class="flex items-center space-x-2 space-x-reverse">
                    <a href="/" class="nav-link px-4 py-2 rounded-lg transition flex items-center">ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
                    <a href="/users" class="nav-link px-4 py-2 rounded-lg transition flex items-center">ØªØ­Ù„ÛŒÙ„ Ú©Ø§Ø±Ø´Ù†Ø§Ø³Ø§Ù†</a>
                    <a href="/history" class="nav-link px-4 py-2 rounded-lg transition flex items-center">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ±ÙˆØ´</a>
                    <a href="/referral" class="nav-link px-4 py-2 rounded-lg transition flex items-center bg-green-500 hover:bg-green-600">Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</a>
                    <a href="/referral-history" class="nav-link px-4 py-2 rounded-lg transition flex items-center bg-purple-600 hover:bg-purple-700 font-bold">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
        <div class="glass-card rounded-3xl p-8 mb-8">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold gradient-text">ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ­Ù„ÛŒÙ„ÛŒ Ø§Ø±Ø¬Ø§Ø¹ÛŒØ§Øª</h2>
                <div class="flex gap-3">
                    <button onclick="exportAllData()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition flex items-center">
                        <i class="fas fa-file-excel ml-2"></i>
                        Ø®Ø±ÙˆØ¬ÛŒ Excel
                    </button>
                    <button onclick="refreshData()" class="bg-purple-600 text-white px-6 py-3 rounded-xl hover:bg-purple-700 transition flex items-center">
                        <i class="fas fa-sync-alt ml-2"></i>
                        Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
            </div>

            <!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø±ÛŒ Ú©Ù„ÛŒ -->
            <div class="grid md:grid-cols-5 gap-4 mb-8" id="overall-stats">
                <!-- Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
            <div class="grid md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¬Ø³ØªØ¬Ùˆ</label>
                    <input type="text" id="search-input" placeholder="Ù†Ø§Ù… ÙØ§ÛŒÙ„..." class="w-full p-3 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø¨Ø§Ø²Ù‡ Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</label>
                    <select id="success-rate-filter" class="w-full p-3 border rounded-xl">
                        <option value="all">Ù‡Ù…Ù‡</option>
                        <option value="high">Ø¨Ø§Ù„Ø§ÛŒ Û·Û°Ùª</option>
                        <option value="medium">ÛµÛ°-Û·Û°Ùª</option>
                        <option value="low">Ø²ÛŒØ± ÛµÛ°Ùª</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ÙˆØ¶Ø¹ÛŒØª Ú¯Ù„ÙˆÚ¯Ø§Ù‡</label>
                    <select id="bottleneck-filter" class="w-full p-3 border rounded-xl">
                        <option value="all">Ù‡Ù…Ù‡</option>
                        <option value="has-bottleneck">Ø¯Ø§Ø±Ø§ÛŒ Ú¯Ù„ÙˆÚ¯Ø§Ù‡</option>
                        <option value="no-bottleneck">Ø¨Ø¯ÙˆÙ† Ú¯Ù„ÙˆÚ¯Ø§Ù‡</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø² ØªØ§Ø±ÛŒØ®</label>
                    <input type="date" id="date-from" class="w-full p-3 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ØªØ§ ØªØ§Ø±ÛŒØ®</label>
                    <input type="date" id="date-to" class="w-full p-3 border rounded-xl">
                </div>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
        <div class="glass-card rounded-3xl p-8">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-purple-100">
                        <tr>
                            <th class="p-4 text-right">Ø±Ø¯ÛŒÙ</th>
                            <th class="p-4 text-right">Ù†Ø§Ù… ÙØ§ÛŒÙ„</th>
                            <th class="p-4 text-right">ØªØ§Ø±ÛŒØ® ØªØ­Ù„ÛŒÙ„</th>
                            <th class="p-4 text-center">Ú©Ù„ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</th>
                            <th class="p-4 text-center">Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡</th>
                            <th class="p-4 text-center">Ø¯Ø±ØµØ¯ Ù…ÙˆÙÙ‚ÛŒØª</th>
                            <th class="p-4 text-center">Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡</th>
                            <th class="p-4 text-center">Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ø§ØµÙ„ÛŒ</th>
                            <th class="p-4 text-center">Ø§Ù…ØªÛŒØ§Ø² Ø³Ù„Ø§Ù…Øª</th>
                            <th class="p-4 text-center">Ø±ÛŒØ³Ú©â€ŒÙ‡Ø§</th>
                            <th class="p-4 text-center">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body">
                        <!-- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </tbody>
                </table>
            </div>

            <!-- ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
            <div class="flex justify-between items-center mt-6">
                <div class="text-gray-600" id="pagination-info"></div>
                <div class="flex gap-2">
                    <button id="prev-page" class="px-4 py-2 bg-purple-600 text-white rounded-lg disabled:opacity-50">Ù‚Ø¨Ù„ÛŒ</button>
                    <button id="next-page" class="px-4 py-2 bg-purple-600 text-white rounded-lg disabled:opacity-50">Ø¨Ø¹Ø¯ÛŒ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-3xl p-8 max-w-6xl w-full mx-4 my-8">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white">
                <h3 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-chart-line text-purple-600 ml-3"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ÛŒ Ú©Ø§Ù…Ù„
                </h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="modal-content" class="space-y-6 max-h-[70vh] overflow-y-auto px-2"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let analyses = [];
        let allAnalyses = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            
            // Event listeners Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§
            document.getElementById('search-input').addEventListener('input', filterTable);
            document.getElementById('success-rate-filter').addEventListener('change', filterTable);
            document.getElementById('bottleneck-filter').addEventListener('change', filterTable);
            document.getElementById('date-from').addEventListener('change', filterTable);
            document.getElementById('date-to').addEventListener('change', filterTable);
            
            document.getElementById('prev-page').addEventListener('click', () => changePage(currentPage - 1));
            document.getElementById('next-page').addEventListener('click', () => changePage(currentPage + 1));
        });

        async function loadHistory() {
            try {
                const response = await fetch('/api/referral-history');
                allAnalyses = await response.json();
                analyses = [...allAnalyses];
                calculateOverallStats();
                renderTable();
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
            }
        }

        function calculateOverallStats() {
            const totalAnalyses = allAnalyses.length;
            const totalReferrals = allAnalyses.reduce((sum, a) => sum + (a.total_referrals || 0), 0);
            const totalCompleted = allAnalyses.reduce((sum, a) => sum + (a.completed_count || 0), 0);
            const totalPending = allAnalyses.reduce((sum, a) => sum + (a.pending_count || 0), 0);
            const avgSuccessRate = totalReferrals ? (totalCompleted / totalReferrals * 100).toFixed(1) : 0;
            
            // ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ù¾Ø±ØªÚ©Ø±Ø§Ø±
            const bottlenecks = allAnalyses.map(a => a.bottleneck_unit).filter(Boolean);
            const topBottleneck = getMostFrequent(bottlenecks);
            
            document.getElementById('overall-stats').innerHTML = `
                <div class="bg-purple-50 p-4 rounded-xl stat-card">
                    <i class="fas fa-chart-bar text-2xl text-purple-600 mb-2"></i>
                    <div class="text-2xl font-bold text-purple-600">${totalAnalyses}</div>
                    <div class="text-sm text-gray-600">Ú©Ù„ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-xl stat-card">
                    <i class="fas fa-phone-alt text-2xl text-blue-600 mb-2"></i>
                    <div class="text-2xl font-bold text-blue-600">${totalReferrals}</div>
                    <div class="text-sm text-gray-600">Ú©Ù„ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl stat-card">
                    <i class="fas fa-check-circle text-2xl text-green-600 mb-2"></i>
                    <div class="text-2xl font-bold text-green-600">${totalCompleted}</div>
                    <div class="text-sm text-gray-600">Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-xl stat-card">
                    <i class="fas fa-clock text-2xl text-yellow-600 mb-2"></i>
                    <div class="text-2xl font-bold text-yellow-600">${totalPending}</div>
                    <div class="text-sm text-gray-600">Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡</div>
                </div>
                <div class="bg-red-50 p-4 rounded-xl stat-card">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600 mb-2"></i>
                    <div class="text-2xl font-bold text-red-600">${topBottleneck || 'â€”'}</div>
                    <div class="text-sm text-gray-600">Ú¯Ù„ÙˆÚ¯Ø§Ù‡ Ø§ØµÙ„ÛŒ</div>
                </div>
            `;
        }

        function getMostFrequent(arr) {
            if (!arr.length) return null;
            const counts = arr.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        }

        function renderTable() {
            const tbody = document.getElementById('history-table-body');
            const filtered = filterAnalyses();
            
            totalPages = Math.ceil(filtered.length / 10);
            const start = (currentPage - 1) * 10;
            const end = start + 10;
            const pageData = filtered.slice(start, end);
            
            tbody.innerHTML = pageData.map((item, index) => {
                const successRate = item.completion_rate || 0;
                const rateClass = successRate >= 70 ? 'bg-green-100 text-green-800' : 
                                 successRate >= 50 ? 'bg-yellow-100 text-yellow-800' : 
                                 'bg-red-100 text-red-800';
                
                const riskCount = item.risk_count || 0;
                const riskClass = riskCount > 2 ? 'bg-red-600' : riskCount > 0 ? 'bg-orange-600' : 'bg-gray-400';
                
                return `
                <tr class="border-b table-row-hover">
                    <td class="p-4">${start + index + 1}</td>
                    <td class="p-4 font-semibold">
                        <i class="fas fa-file-excel text-green-600 ml-2"></i>
                        ${item.file_name}
                    </td>
                    <td class="p-4">${new Date(item.analyzed_at).toLocaleDateString('fa-IR')}</td>
                    <td class="p-4 text-center font-bold">${item.total_referrals}</td>
                    <td class="p-4 text-center font-bold text-green-600">${item.completed_count}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-bold ${rateClass}">
                            ${successRate}%
                        </span>
                    </td>
                    <td class="p-4 text-center font-bold text-red-600">${item.pending_count}</td>
                    <td class="p-4 text-center">
                        ${item.bottleneck_unit ? 
                            `<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
                                ${item.bottleneck_unit}
                            </span>` : 
                            '<span class="text-gray-400">â€”</span>'
                        }
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 ${getHealthClass(item.health_score)} rounded-full text-sm font-bold">
                            ${item.health_score || 'â€”'}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        ${riskCount > 0 ? 
                            `<span class="px-3 py-1 ${riskClass} text-white rounded-full text-sm font-bold">
                                ${riskCount} Ø±ÛŒØ³Ú©
                            </span>` : 
                            '<span class="text-gray-400">â€”</span>'
                        }
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="showDetails(${item.id})" class="text-purple-600 hover:text-purple-800 ml-3" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="downloadReport(${item.id})" class="text-green-600 hover:text-green-800 ml-3" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´">
                            <i class="fas fa-download"></i>
                        </button>
                        <button onclick="compareWithPrevious(${item.id})" class="text-blue-600 hover:text-blue-800" title="Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¨Ø§ Ù‚Ø¨Ù„ÛŒ">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            
            document.getElementById('pagination-info').textContent = 
                `Ù†Ù…Ø§ÛŒØ´ ${start + 1} ØªØ§ ${Math.min(end, filtered.length)} Ø§Ø² ${filtered.length} Ø±Ú©ÙˆØ±Ø¯`;
        }

        function getHealthClass(score) {
            if (!score) return 'bg-gray-100 text-gray-800';
            if (score >= 80) return 'bg-green-100 text-green-800';
            if (score >= 60) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function filterAnalyses() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const successRate = document.getElementById('success-rate-filter').value;
            const bottleneck = document.getElementById('bottleneck-filter').value;
            const from = document.getElementById('date-from').value;
            const to = document.getElementById('date-to').value;
            
            return allAnalyses.filter(a => {
                if (search && !a.file_name.toLowerCase().includes(search)) return false;
                
                const rate = a.completion_rate || 0;
                if (successRate === 'high' && rate < 70) return false;
                if (successRate === 'medium' && (rate < 50 || rate >= 70)) return false;
                if (successRate === 'low' && rate >= 50) return false;
                
                if (bottleneck === 'has-bottleneck' && !a.bottleneck_unit) return false;
                if (bottleneck === 'no-bottleneck' && a.bottleneck_unit) return false;
                
                const date = new Date(a.analyzed_at);
                if (from && date < new Date(from)) return false;
                if (to && date > new Date(to)) return false;
                
                return true;
            });
        }

        function filterTable() {
            currentPage = 1;
            renderTable();
        }

        function changePage(newPage) {
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        async function showDetails(id) {
            try {
                const response = await fetch(`/api/referral-analysis/${id}`);
                const data = await response.json();
                
                const modal = document.getElementById('detail-modal');
                const content = document.getElementById('modal-content');
                
                content.innerHTML = renderDetailedAnalysis(data);
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
            }
        }

        function renderDetailedAnalysis(data) {
            const full = data.full_analysis || {};
            const status = full.status_analysis || {};
            const subject = full.subject_analysis || {};
            const senderReceiver = full.sender_receiver_analysis || {};
            const institution = full.institution_analysis || {};
            const insights = full.comprehensive_insights || {};
            const description = full.description_analysis || {};
            
            return `
                <!-- Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
                <div class="grid grid-cols-5 gap-4">
                    <div class="bg-purple-50 p-4 rounded-xl text-center">
                        <i class="fas fa-chart-bar text-2xl text-purple-600 mb-2"></i>
                        <div class="text-2xl font-bold text-purple-600">${data.total_referrals}</div>
                        <div class="text-sm">Ú©Ù„ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl text-center">
                        <i class="fas fa-check-circle text-2xl text-green-600 mb-2"></i>
                        <div class="text-2xl font-bold text-green-600">${data.completed_count}</div>
                        <div class="text-sm">Ø§ØªÙ…Ø§Ù… ÛŒØ§ÙØªÙ‡</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl text-center">
                        <i class="fas fa-clock text-2xl text-red-600 mb-2"></i>
                        <div class="text-2xl font-bold text-red-600">${data.pending_count}</div>
                        <div class="text-sm">Ø¨Ø±Ø±Ø³ÛŒ Ù†Ø´Ø¯Ù‡</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-xl text-center">
                        <i class="fas fa-percent text-2xl text-yellow-600 mb-2"></i>
                        <div class="text-2xl font-bold text-yellow-600">${data.completion_rate}%</div>
                        <div class="text-sm">Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª</div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-xl text-center">
                        <i class="fas fa-heartbeat text-2xl text-indigo-600 mb-2"></i>
                        <div class="text-2xl font-bold text-indigo-600">${insights.workflow_health_score || 'â€”'}</div>
                        <div class="text-sm">Ø§Ù…ØªÛŒØ§Ø² Ø³Ù„Ø§Ù…Øª</div>
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: ØªÙˆØ²ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„ Ú¯Ù„ÙˆÚ¯Ø§Ù‡ -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h4 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-chart-pie text-purple-600 ml-2"></i>
                            ØªÙˆØ²ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§
                        </h4>
                        <div class="space-y-3">
                            ${Object.entries(status.status_distribution || {}).map(([key, value]) => `
                                <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                                    <span class="font-medium">${key}</span>
                                    <span class="bg-purple-600 text-white px-4 py-1 rounded-full text-sm font-bold">${value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h4 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-exclamation-triangle text-red-600 ml-2"></i>
                            ØªØ­Ù„ÛŒÙ„ Ú¯Ù„ÙˆÚ¯Ø§Ù‡â€ŒÙ‡Ø§
                        </h4>
                        <div class="space-y-4">
                            ${(insights.top_bottlenecks || []).map(b => `
                                <div class="bg-white p-4 rounded-lg border-r-4 ${b.impact === 'Ø¨Ø§Ù„Ø§' ? 'border-red-500' : b.impact === 'Ù…ØªÙˆØ³Ø·' ? 'border-yellow-500' : 'border-blue-500'}">
                                    <div class="flex justify-between items-center">
                                        <span class="font-bold">${b.bottleneck}</span>
                                        <span class="bg-gray-200 px-3 py-1 rounded-full text-sm">${b.pending_count} Ù…Ø§Ù†Ø¯Ù‡</span>
                                    </div>
                                    <span class="text-sm text-gray-600">ØªØ£Ø«ÛŒØ±: ${b.impact}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ø³ÙˆÙ…: Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ùˆ ÙˆØ§Ø­Ø¯Ù‡Ø§ -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h4 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-tags text-green-600 ml-2"></i>
                            Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¨Ø§ Ú©Ø§Ø± Ù…Ø§Ù†Ø¯Ù‡
                        </h4>
                        <div class="space-y-2">
                            ${Object.entries(subject.subject_pending || {}).map(([subj, count]) => `
                                <div class="bg-white p-3 rounded-lg flex justify-between items-center">
                                    <span>${subj}</span>
                                    <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-bold">${count} Ù…Ø§Ù†Ø¯Ù‡</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-xl">
                        <h4 class="font-bold text-lg mb-4 flex items-center">
                            <i class="fas fa-users text-blue-600 ml-2"></i>
                            Ù¾Ø±Ú©Ø§Ø±ØªØ±ÛŒÙ† ÙˆØ§Ø­Ø¯Ù‡Ø§
                        </h4>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg">
                                <span class="text-sm text-gray-600">ÙØ±Ø³ØªÙ†Ø¯Ù‡â€ŒÙ‡Ø§:</span>
                                ${(senderReceiver.top_senders || []).map(s => `
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="font-medium">${s.sender}</span>
                                        <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">${s.count}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="bg-white p-3 rounded-lg mt-3">
                                <span class="text-sm text-gray-600">Ú¯ÛŒØ±Ù†Ø¯Ù‡â€ŒÙ‡Ø§:</span>
                                ${(senderReceiver.top_receivers || []).map(r => `
                                    <div class="flex justify-between items-center mt-2">
                                        <span class="font-medium">${r.receiver}</span>
                                        <span class="bg-green-600 text-white px-3 py-1 rounded-full text-sm">${r.count}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ú†Ù‡Ø§Ø±Ù…: ØªØ­Ù„ÛŒÙ„ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ -->
                <div class="bg-gray-50 p-6 rounded-xl">
                    <h4 class="font-bold text-lg mb-4 flex items-center">
                        <i class="fas fa-key text-yellow-600 ml-2"></i>
                        Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¯Ø± ØªÙˆØ¶ÛŒØ­Ø§Øª
                    </h4>
                    <div class="flex flex-wrap gap-3">
                        ${(description.top_keywords || []).map(k => `
                            <div class="bg-white px-4 py-2 rounded-full shadow-sm border ${k.completion_rate > 70 ? 'border-green-300' : 'border-gray-200'}">
                                <span class="font-medium">${k.word}</span>
                                <span class="text-sm text-gray-500 mr-2">${k.count} Ø¨Ø§Ø±</span>
                                <span class="text-xs ${k.completion_rate > 70 ? 'text-green-600' : 'text-gray-500'}">${k.completion_rate || 0}% Ù…ÙˆÙÙ‚ÛŒØª</span>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ù¾Ù†Ø¬Ù…: Ù…Ø´ØªØ±ÛŒØ§Ù† Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© -->
                <div class="bg-gray-50 p-6 rounded-xl">
                    <h4 class="font-bold text-lg mb-4 flex items-center">
                        <i class="fas fa-building text-purple-600 ml-2"></i>
                        Ù…Ø´ØªØ±ÛŒØ§Ù† Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ©
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        ${(institution.top_institutions || []).map(inst => `
                            <div class="bg-white p-4 rounded-lg">
                                <div class="font-bold text-purple-700">${inst.name}</div>
                                <div class="text-sm text-gray-600 mt-2">
                                    <span class="block">${inst.count} Ø§Ø±Ø¬Ø§Ø¹</span>
                                    <span class="block">Ø§Ø´ØªØ±Ø§Ú©: ${inst.subs || 'â€”'}</span>
                                    <span class="block mt-1 ${inst.completion_rate === 100 ? 'text-green-600' : inst.completion_rate === 0 ? 'text-red-600' : 'text-yellow-600'}">
                                        ${inst.completion_rate || 0}% Ù…ÙˆÙÙ‚ÛŒØª
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Ø±Ø¯ÛŒÙ Ø´Ø´Ù…: Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ Ùˆ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ -->
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-8 rounded-xl">
                    <h4 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-3xl ml-3"></i>
                        Ø¨ÛŒÙ†Ø´â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯
                    </h4>
                    <p class="text-lg leading-relaxed mb-6 opacity-90">${insights.summary_fa || ''}</p>
                    
                    <h4 class="text-xl font-bold mb-3">ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ:</h4>
                    <ul class="space-y-3">
                        ${(insights.recommendations_fa || []).map(rec => `
                            <li class="flex items-start bg-white bg-opacity-20 rounded-lg p-4">
                                <i class="fas fa-check-circle mt-1 ml-3 text-green-300 text-xl"></i>
                                <span class="text-lg">${rec}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
        }

        async function downloadReport(id) {
            window.location.href = `/api/referral-report/${id}`;
        }

        function compareWithPrevious(id) {
            // Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¯Ùˆ ØªØ­Ù„ÛŒÙ„
            const index = allAnalyses.findIndex(a => a.id === id);
            if (index > 0) {
                showComparison(id, allAnalyses[index - 1].id);
            } else {
                alert('ØªØ­Ù„ÛŒÙ„ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            }
        }

        async function showComparison(id1, id2) {
            // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ø¯Ùˆ ØªØ­Ù„ÛŒÙ„ Ø±Ùˆ Ù…Ù‚Ø§ÛŒØ³Ù‡ Ú©Ù†Ù‡
            // Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯
        }

        function exportAllData() {
            // Ø®Ø±ÙˆØ¬ÛŒ Excel Ø§Ø² Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            window.location.href = '/api/referral-export-all';
        }

        function refreshData() {
            loadHistory();
        }
    </script>
</body>
</html>